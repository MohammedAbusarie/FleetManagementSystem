{% extends 'base.html' %}
{% load i18n %}

{% block title %}الجداول العامة - نظام إدارة الأسطول{% endblock %}

{% block content %}
<style>
/* Ensure sidebar is always visible */
.col-md-4.col-lg-3 {
    position: relative;
    z-index: 1;
}

.scrollable-list {
    max-height: 500px;
    overflow-y: auto;
    overflow-x: hidden;
}

.scrollable-list::-webkit-scrollbar {
    width: 6px;
}

.scrollable-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.scrollable-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.scrollable-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.list-group-item {
    border: none;
    border-bottom: 1px solid #dee2e6;
    transition: all 0.2s ease;
    cursor: pointer;
}

.list-group-item:hover {
    background-color: #f8f9fa;
    border-left: 4px solid #003366;
}

.list-group-item.active {
    background-color: #003366;
    color: white;
    border-left: 4px solid #FF9933;
}

.list-group-item.active:hover {
    background-color: #002244;
}

.list-group-item.active .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

.table-selector h6 {
    font-size: 1rem;
    font-weight: 600;
}

.table-selector small {
    font-size: 0.85rem;
}

#table-content {
    min-height: 400px;
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #003366;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Optimized spinner - GPU accelerated */
@keyframes spin {
    0% { transform: rotate3d(0, 0, 1, 0deg); }
    100% { transform: rotate3d(0, 0, 1, 360deg); }
}

.loading::after {
    will-change: transform;
    backface-visibility: hidden;
    perspective: 1000px;
}
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-table"></i> إدارة الجداول العامة</h1>
    </div>
    
    <div class="row">
        <!-- Tables List Sidebar -->
        <div class="col-md-4 col-lg-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-ul me-2"></i>الجداول المتاحة
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush scrollable-list">
                        {% for model in ddl_models %}
                        <a href="#" class="list-group-item list-group-item-action table-selector" 
                           data-model="{{ model.name }}" 
                           data-arabic="{{ model.arabic }}">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ model.arabic }}</h6>
                                    <small class="text-muted">إدارة بيانات {{ model.arabic }}</small>
                                </div>
                                <i class="bi bi-chevron-left"></i>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="col-md-8 col-lg-9">
            <div id="table-content">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-table display-1"></i>
                    <h4 class="mt-3">اختر جدولاً من القائمة</h4>
                    <p>اختر جدولاً من القائمة الجانبية لبدء إدارة البيانات</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Generic Tables JavaScript - Clean and Simple
document.addEventListener('DOMContentLoaded', function() {
    // Get elements
    const tableSelectors = document.querySelectorAll('.table-selector');
    const contentArea = document.getElementById('table-content');

    if (!tableSelectors.length || !contentArea) {
        return; // Not on generic tables page
    }
    
    // Function to select and load a table
    function selectAndLoadTable(modelName) {
        const selectedSelector = document.querySelector(`.table-selector[data-model="${modelName}"]`);
        if (!selectedSelector) return;
        
        // Remove active class from all selectors
        document.querySelectorAll('.table-selector').forEach(s => s.classList.remove('active'));
        
        // Add active class to selected selector
        selectedSelector.classList.add('active');
        
        // Show loading state
        contentArea.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">جاري التحميل...</span>
                </div>
                <p class="mt-3 text-muted">جاري تحميل البيانات...</p>
            </div>
        `;
        
        // Load table data via AJAX
        loadTableData(modelName);
    }
    
    // Set up click handlers for all table selectors
    tableSelectors.forEach((selector) => {
        selector.addEventListener('click', function(e) {
            e.preventDefault();
            selectAndLoadTable(this.dataset.model);
        });
    });
    
    // Check if there's a selected model from session
    {% if selected_model %}
    setTimeout(function() {
        selectAndLoadTable('{{ selected_model }}');
    }, 100);
    {% endif %}
});

// Function to load table data
function loadTableData(modelName) {
    const contentArea = document.getElementById('table-content');
    if (!contentArea) return;
    
    fetch(`/generic-tables/${modelName}/?ajax=1`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.text();
        })
        .then(html => {
            contentArea.innerHTML = html;
            const activeSelector = document.querySelector('.table-selector.active');
            if (activeSelector) {
                document.title = `${activeSelector.dataset.arabic} - نظام إدارة الأسطول`;
            }
            initializeSearch(modelName);
        })
        .catch(error => {
            console.error('Error loading table:', error);
            contentArea.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.
                </div>
            `;
        });
}

// Function to search within a table
function searchTable(modelName, searchTerm) {
    const tableBody = document.getElementById(`table-body-${modelName}`);
    const resultsCount = document.getElementById(`results-count-${modelName}`);
    
    if (!tableBody) return;
    
    const rows = tableBody.getElementsByTagName('tr');
    let visibleCount = 0;
    
    Array.from(rows).forEach(row => {
        const text = row.textContent.toLowerCase();
        const matches = text.includes(searchTerm.toLowerCase());
        row.style.display = matches ? '' : 'none';
        if (matches) visibleCount++;
    });
    
    if (resultsCount) {
        resultsCount.textContent = `عرض ${visibleCount} من ${rows.length}`;
    }
}

// Function to clear search
function clearSearch(modelName) {
    const searchInput = document.getElementById(`search-input-${modelName}`);
    if (searchInput) {
        searchInput.value = '';
        searchTable(modelName, '');
    }
}

// Initialize search functionality for a specific table
function initializeSearch(modelName) {
    const searchInput = document.getElementById(`search-input-${modelName}`);
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            searchTable(modelName, e.target.value);
        });
    }
}
</script>
{% endblock %}
