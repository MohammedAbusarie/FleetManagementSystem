{% extends 'base.html' %}
{% load i18n %}

{% block title %}الجداول العامة - نظام إدارة الأسطول{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-table"></i> إدارة الجداول العامة</h1>
    </div>
    
    <div class="row">
        <!-- Tables List Sidebar -->
        <div class="col-md-4 col-lg-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-ul me-2"></i>الجداول المتاحة
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush scrollable-list">
                        {% for model in ddl_models %}
                        <a href="#" class="list-group-item list-group-item-action table-selector" 
                           data-model="{{ model.name }}" 
                           data-arabic="{{ model.arabic }}">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ model.arabic }}</h6>
                                    <small class="text-muted">إدارة بيانات {{ model.arabic }}</small>
                                </div>
                                <i class="bi bi-chevron-left"></i>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="col-md-8 col-lg-9">
            <div id="table-content">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-table display-1"></i>
                    <h4 class="mt-3">اختر جدولاً من القائمة</h4>
                    <p>اختر جدولاً من القائمة الجانبية لبدء إدارة البيانات</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Ensure sidebar is always visible */
.col-md-4.col-lg-3 {
    position: relative;
    z-index: 1;
}

.scrollable-list {
    max-height: 500px;
    overflow-y: auto;
    overflow-x: hidden;
}

.scrollable-list::-webkit-scrollbar {
    width: 6px;
}

.scrollable-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.scrollable-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.scrollable-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.list-group-item {
    border: none;
    border-bottom: 1px solid #dee2e6;
    transition: all 0.2s ease;
    cursor: pointer;
}

.list-group-item:hover {
    background-color: #f8f9fa;
    border-left: 4px solid #007bff;
}

.list-group-item.active {
    background-color: #007bff;
    color: white;
    border-left: 4px solid #0056b3;
}

.list-group-item.active:hover {
    background-color: #0056b3;
}

.list-group-item.active .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

.table-selector h6 {
    font-size: 1rem;
    font-weight: 600;
}

.table-selector small {
    font-size: 0.85rem;
}

#table-content {
    min-height: 400px;
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableSelectors = document.querySelectorAll('.table-selector');
    const contentArea = document.getElementById('table-content');
    
    // Function to select and load a table
    function selectAndLoadTable(modelName) {
        const selectedSelector = document.querySelector(`.table-selector[data-model="${modelName}"]`);
        if (selectedSelector) {
            // Remove active class from all selectors
            tableSelectors.forEach(s => s.classList.remove('active'));
            
            // Add active class to selected selector
            selectedSelector.classList.add('active');
            
            // Get model information
            const arabicName = selectedSelector.dataset.arabic;
            
            // Show loading state
            contentArea.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                    <p class="mt-3 text-muted">جاري تحميل البيانات...</p>
                </div>
            `;
            
            // Load table data via AJAX
            loadTableData(modelName);
        }
    }
    
    // Set up click handlers for all table selectors
    tableSelectors.forEach(selector => {
        selector.addEventListener('click', function(e) {
            e.preventDefault();
            const modelName = this.dataset.model;
            selectAndLoadTable(modelName);
        });
    });
    
    // Check if there's a selected model from session (after redirect from create/update/delete)
    {% if selected_model %}
    const selectedModel = '{{ selected_model }}';
    console.log('Auto-loading table after redirect:', selectedModel);
    // Use setTimeout to ensure DOM is fully ready and event listeners are attached
    setTimeout(function() {
        console.log('Attempting to load table:', selectedModel);
        selectAndLoadTable(selectedModel);
    }, 100);
    {% endif %}
    
    // Ensure sidebar is always visible (defensive check)
    const sidebar = document.querySelector('.col-md-4.col-lg-3');
    if (sidebar) {
        sidebar.style.display = 'block';
        console.log('Sidebar is visible');
    } else {
        console.error('Sidebar not found!');
    }
});

// Function to load table data
function loadTableData(modelName) {
    console.log(`Loading table data for ${modelName}`);
    const contentArea = document.getElementById('table-content');
    
    if (!contentArea) {
        console.error('Content area not found');
        return;
    }
    
    // Show loading state
    contentArea.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <p class="mt-3 text-muted">جاري تحميل البيانات...</p>
        </div>
    `;
    
    // Load table data via AJAX
    fetch(`/generic-tables/${modelName}/?ajax=1`)
        .then(response => {
            console.log(`Response status: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            console.log('HTML loaded successfully');
            contentArea.innerHTML = html;
            // Update page title
            const activeSelector = document.querySelector('.table-selector.active');
            if (activeSelector) {
                const arabicName = activeSelector.dataset.arabic;
                document.title = `${arabicName} - نظام إدارة الأسطول`;
            }
            // Initialize search functionality for the loaded table
            initializeSearch(modelName);
        })
        .catch(error => {
            console.error('Error loading table:', error);
            contentArea.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.
                    <br><small>تفاصيل الخطأ: ${error.message}</small>
                    <br><a href="javascript:location.reload()" class="btn btn-sm btn-primary mt-2">إعادة تحميل الصفحة</a>
                </div>
            `;
        });
}

// Function to search within a table
function searchTable(modelName, searchTerm) {
    const searchInput = document.getElementById(`search-input-${modelName}`);
    const tableBody = document.getElementById(`table-body-${modelName}`);
    const resultsCount = document.getElementById(`results-count-${modelName}`);
    
    if (!tableBody || !resultsCount) {
        console.error('Table elements not found for search');
        return;
    }
    
    const rows = tableBody.querySelectorAll('.table-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const nameCell = row.querySelector('.searchable-text');
        const rowName = nameCell ? nameCell.textContent.toLowerCase() : '';
        
        if (rowName.includes(searchTerm.toLowerCase())) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update results count
    resultsCount.textContent = visibleCount;
    
    // Show/hide "no results" message
    const noResultsMsg = tableBody.parentElement.querySelector('.no-results-msg');
    if (visibleCount === 0 && searchTerm.length > 0) {
        if (!noResultsMsg) {
            const msg = document.createElement('tr');
            msg.className = 'no-results-msg';
            msg.innerHTML = '<td colspan="4" class="text-center text-muted py-4">لم يتم العثور على نتائج</td>';
            tableBody.appendChild(msg);
        }
    } else if (noResultsMsg) {
        noResultsMsg.remove();
    }
}

// Function to clear search
function clearSearch(modelName) {
    const searchInput = document.getElementById(`search-input-${modelName}`);
    if (searchInput) {
        searchInput.value = '';
        searchTable(modelName, '');
    }
}

// Initialize search functionality for a specific table
function initializeSearch(modelName) {
    const searchInput = document.getElementById(`search-input-${modelName}`);
    
    if (searchInput) {
        // Remove existing event listeners
        searchInput.removeEventListener('input', searchInput._searchHandler);
        
        // Add new event listener
        searchInput._searchHandler = function(e) {
            searchTable(modelName, e.target.value);
        };
        
        searchInput.addEventListener('input', searchInput._searchHandler);
        console.log(`Search initialized for ${modelName}`);
    }
}

// Make functions globally available
window.loadTableData = loadTableData;
window.clearSearch = clearSearch;

// Ensure functions are available when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Make sure functions are available globally
    window.loadTableData = loadTableData;
    window.clearSearch = clearSearch;
    console.log('Table functions initialized and available globally');
});
</script>
{% endblock %}


