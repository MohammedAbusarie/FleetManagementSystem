{% extends 'base.html' %}
{% load i18n %}
{% load inventory_extras %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{% if action == 'Create' %}إضافة{% else %}تعديل{% endif %} معدة - نظام إدارة الأسطول{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-tools"></i> {% if action == 'Create' %}إضافة معدة{% else %}تعديل معدة{% endif %}</h1>
        <a href="{% url 'equipment_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> العودة إلى القائمة
        </a>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="equipmentForm">
                {% csrf_token %}
                
                <!-- Section 1: Basic Information - Expanded by default -->
                <div class="card mb-3 border-info">
                    <div class="card-header bg-info text-white" data-bs-toggle="collapse" data-bs-target="#basicInfoCollapse" aria-expanded="true" aria-controls="basicInfoCollapse" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>المعلومات الأساسية
                            <i class="bi bi-chevron-up float-end collapse-icon"></i>
                        </h5>
                    </div>
                    <div id="basicInfoCollapse" class="collapse show">
                        <div class="card-body">
                            <div class="row">
                                {% for field in form %}
                                    {% if field.name == 'door_no' or field.name == 'plate_no' or field.name == 'manufacture_year' or field.name == 'manufacturer' or field.name == 'model' or field.name == 'status' %}
                                        <div class="col-md-6 mb-3">
                                            {{ field|as_crispy_field }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section 2: Organizational Hierarchy - Expanded by default -->
                <div class="card mb-3 border-primary">
                    <div class="card-header bg-primary text-white" data-bs-toggle="collapse" data-bs-target="#orgHierarchyCollapse" aria-expanded="true" aria-controls="orgHierarchyCollapse" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="bi bi-diagram-3 me-2"></i>التسلسل الهرمي التنظيمي
                            <i class="bi bi-chevron-up float-end collapse-icon"></i>
                        </h5>
                    </div>
                    <div id="orgHierarchyCollapse" class="collapse show">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="{{ form.sector.id_for_label }}" class="form-label fw-bold">{{ form.sector.label }} <span class="text-danger">*</span></label>
                                        {{ form.sector }}
                                        {% if form.sector.errors %}
                                            <div class="text-danger small mt-1">{{ form.sector.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">اختر القطاع أولاً</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="{{ form.department.id_for_label }}" class="form-label fw-bold">{{ form.department.label }}</label>
                                        {{ form.department }}
                                        {% if form.department.errors %}
                                            <div class="text-danger small mt-1">{{ form.department.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">اختر الإدارة بعد القطاع</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="{{ form.division.id_for_label }}" class="form-label fw-bold">{{ form.division.label }} <span class="text-danger">*</span></label>
                                        {{ form.division }}
                                        {% if form.division.errors %}
                                            <div class="text-danger small mt-1">{{ form.division.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">اختر الدائرة بعد الإدارة</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section 3: Location Information - Expanded by default -->
                <div class="card mb-3 border-success">
                    <div class="card-header bg-success text-white" data-bs-toggle="collapse" data-bs-target="#locationInfoCollapse" aria-expanded="true" aria-controls="locationInfoCollapse" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="bi bi-geo-alt me-2"></i>معلومات الموقع
                            <i class="bi bi-chevron-up float-end collapse-icon"></i>
                        </h5>
                    </div>
                    <div id="locationInfoCollapse" class="collapse show">
                        <div class="card-body">
                            <div class="row">
                                {% for field in form %}
                                    {% if field.name == 'location' %}
                                        <div class="col-md-6 mb-3">
                                            {{ field|as_crispy_field }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section 4: License Records - Expanded by default -->
                <div class="card mb-3 border-primary">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#licenseRecordsCollapse" aria-expanded="true" aria-controls="licenseRecordsCollapse" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="bi bi-card-text me-2"></i>سجلات رخص المعدة
                            <i class="bi bi-chevron-up collapse-icon"></i>
                        </h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="event.stopPropagation(); addLicenseForm();">
                            <i class="bi bi-plus-circle"></i> إضافة سجل رخصة
                        </button>
                    </div>
                    <div id="licenseRecordsCollapse" class="collapse show">
                        <div class="card-body">
                            {{ license_formset.management_form }}
                            <div id="license-forms-container">
                                {% for form in license_formset %}
                                    <div class="license-form card mb-3" data-form-index="{{ forloop.counter0 }}">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="bi bi-file-text"></i> سجل رخصة {{ forloop.counter }}</h6>
                                            {% if form.instance.pk %}
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeLicenseForm(this)">
                                                    <i class="bi bi-trash"></i> حذف السجل
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLicenseForm(this)">
                                                    <i class="bi bi-x-circle"></i> إزالة
                                                </button>
                                            {% endif %}
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">تاريخ بداية رخصة المعدة *</label>
                                                        {{ form.start_date }}
                                                        {% if form.start_date.errors %}
                                                            <div class="text-danger small">{{ form.start_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">تاريخ انتهاء رخصة المعدة *</label>
                                                        {{ form.end_date }}
                                                        {% if form.end_date.errors %}
                                                            <div class="text-danger small">{{ form.end_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% if form.instance.pk %}
                                                {{ form.DELETE }}
                                            {% endif %}
                                            {% for hidden_field in form.hidden_fields %}
                                                {{ hidden_field }}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section 5: Inspection Records - Expanded by default -->
                <div class="card mb-3 border-success">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#inspectionRecordsCollapse" aria-expanded="true" aria-controls="inspectionRecordsCollapse" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="bi bi-clipboard-check me-2"></i>سجلات الفحص السنوي
                            <i class="bi bi-chevron-up collapse-icon"></i>
                        </h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="event.stopPropagation(); addInspectionForm();">
                            <i class="bi bi-plus-circle"></i> إضافة سجل فحص
                        </button>
                    </div>
                    <div id="inspectionRecordsCollapse" class="collapse show">
                        <div class="card-body">
                            {{ inspection_formset.management_form }}
                            <div id="inspection-forms-container">
                                {% for form in inspection_formset %}
                                    <div class="inspection-form card mb-3" data-form-index="{{ forloop.counter0 }}">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> سجل فحص {{ forloop.counter }}</h6>
                                            {% if form.instance.pk %}
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeInspectionForm(this)">
                                                    <i class="bi bi-trash"></i> حذف السجل
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeInspectionForm(this)">
                                                    <i class="bi bi-x-circle"></i> إزالة
                                                </button>
                                            {% endif %}
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">تاريخ بداية الفحص السنوي *</label>
                                                        {{ form.start_date }}
                                                        {% if form.start_date.errors %}
                                                            <div class="text-danger small">{{ form.start_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">تاريخ انتهاء الفحص السنوي *</label>
                                                        {{ form.end_date }}
                                                        {% if form.end_date.errors %}
                                                            <div class="text-danger small">{{ form.end_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% if form.instance.pk %}
                                                {{ form.DELETE }}
                                            {% endif %}
                                            {% for hidden_field in form.hidden_fields %}
                                                {{ hidden_field }}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section 6: Fire Extinguisher Records - Expanded by default -->
                <div class="card mb-3 border-danger">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#fireExtinguisherRecordsCollapse" aria-expanded="true" aria-controls="fireExtinguisherRecordsCollapse" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="bi bi-fire me-2"></i>سجلات فحص طفاية الحريق
                            <i class="bi bi-chevron-up collapse-icon"></i>
                        </h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="event.stopPropagation(); addFireExtinguisherForm();">
                            <i class="bi bi-plus-circle"></i> إضافة سجل طفاية حريق
                        </button>
                    </div>
                    <div id="fireExtinguisherRecordsCollapse" class="collapse show">
                        <div class="card-body">
                            {{ fire_extinguisher_formset.management_form }}
                            <div id="fire-extinguisher-forms-container">
                                {% for form in fire_extinguisher_formset %}
                                    <div class="fire-extinguisher-form card mb-3" data-form-index="{{ forloop.counter0 }}">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="bi bi-fire"></i> سجل طفاية حريق {{ forloop.counter }}</h6>
                                            {% if form.instance.pk %}
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeFireExtinguisherForm(this)">
                                                    <i class="bi bi-trash"></i> حذف السجل
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFireExtinguisherForm(this)">
                                                    <i class="bi bi-x-circle"></i> إزالة
                                                </button>
                                            {% endif %}
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">تاريخ الفحص الدوري لطفاية الحريق *</label>
                                                        {{ form.inspection_date }}
                                                        {% if form.inspection_date.errors %}
                                                            <div class="text-danger small">{{ form.inspection_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">تاريخ انتهاء طفاية الحريق *</label>
                                                        {{ form.expiry_date }}
                                                        {% if form.expiry_date.errors %}
                                                            <div class="text-danger small">{{ form.expiry_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% if form.instance.pk %}
                                                {{ form.DELETE }}
                                            {% endif %}
                                            {% for hidden_field in form.hidden_fields %}
                                                {{ hidden_field }}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section 7: Maintenance Records - Collapsible (Shown when status is under_maintenance) -->
                <div class="card mb-3 border-warning" id="maintenance-records-card" style="display: none;">
                    <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#maintenanceRecordsCollapse" aria-expanded="false" aria-controls="maintenanceRecordsCollapse" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="bi bi-tools me-2"></i>سجلات الصيانة
                            <i class="bi bi-chevron-down collapse-icon"></i>
                        </h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="event.stopPropagation(); addMaintenanceForm();">
                            <i class="bi bi-plus-circle"></i> إضافة سجل صيانة
                        </button>
                    </div>
                    <div id="maintenanceRecordsCollapse" class="collapse">
                        <div class="card-body">
                            {{ maintenance_formset.management_form }}
                            <div id="maintenance-forms-container">
                                {% for form in maintenance_formset %}
                                    <div class="maintenance-form card mb-3" data-form-index="{{ forloop.counter0 }}">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="bi bi-wrench"></i> سجل صيانة {{ forloop.counter }}</h6>
                                            {% if form.instance.pk %}
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeMaintenanceForm(this)">
                                                    <i class="bi bi-trash"></i> حذف السجل
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMaintenanceForm(this)">
                                                    <i class="bi bi-x-circle"></i> إزالة
                                                </button>
                                            {% endif %}
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">تاريخ الصيانة *</label>
                                                        {{ form.maintenance_date }}
                                                        {% if form.maintenance_date.errors %}
                                                            <div class="text-danger small">{{ form.maintenance_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">تاريخ الإصلاح</label>
                                                        {{ form.restoration_date }}
                                                        {% if form.restoration_date.errors %}
                                                            <div class="text-danger small">{{ form.restoration_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">التكلفة (ريال سعودي)</label>
                                                        {{ form.cost }}
                                                        {% if form.cost.errors %}
                                                            <div class="text-danger small">{{ form.cost.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-bold">الوصف</label>
                                                        {{ form.description }}
                                                        {% if form.description.errors %}
                                                            <div class="text-danger small">{{ form.description.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% if form.instance.pk %}
                                                {{ form.DELETE }}
                                            {% endif %}
                                            {% for hidden_field in form.hidden_fields %}
                                                {{ hidden_field }}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section 8: Images & Media - Expanded by default -->
                <div class="card mb-3 border-secondary" id="images-media-card">
                    <div class="card-header bg-secondary text-white" data-bs-toggle="collapse" data-bs-target="#imagesMediaCollapse" aria-expanded="true" aria-controls="imagesMediaCollapse" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="bi bi-images me-2"></i>الصور والوسائط
                            <i class="bi bi-chevron-up float-end collapse-icon"></i>
                        </h5>
                    </div>
                    <div id="imagesMediaCollapse" class="collapse show">
                        <div class="card-body">
                            <!-- Equipment Images -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">صور المعدة</label>
                                <input type="file" class="form-control" id="equipment_images" name="equipment_images" multiple accept="image/*">
                                <div class="form-text">يمكنك اختيار صور متعددة للمعدة.</div>
                            </div>
                            
                            {% if equipment and equipment.equipment_images.all %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">الصور الموجودة</label>
                                <div class="row">
                                    {% for img in equipment.equipment_images.all %}
                                    <div class="col-md-3 mb-2">
                                        <div class="image-container position-relative">
                                            <img src="{{ img.image|secure_media_url }}" class="img-thumbnail" alt="Equipment Image" id="img-{{ img.id }}">
                                            <div class="mt-2 text-center">
                                                <button type="button" class="btn btn-sm btn-danger delete-image" data-img-id="{{ img.id }}" data-img-name="{{ img.image.name|basename }}">
                                                    <i class="bi bi-trash"></i> حذف الصورة
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Calibration Certificates -->
                            <div class="mb-3">
                                <label for="calibration_certificates" class="form-label fw-bold">شهادات المعايرة (صور وملفات PDF)</label>
                                <input type="file" class="form-control" id="calibration_certificates" name="calibration_certificates" multiple accept="image/*,.pdf">
                                <div class="form-text">يمكنك اختيار صور أو ملفات PDF متعددة لشهادات المعايرة.</div>
                            </div>
                            
                            {% if equipment and equipment.calibration_certificates.all %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">شهادات المعايرة الموجودة</label>
                                <div class="row">
                                    {% for cert in equipment.calibration_certificates.all %}
                                    <div class="col-md-3 mb-2">
                                        <div class="certificate-container position-relative">
                                            {% if cert.is_image %}
                                                <img src="{{ cert.image|secure_media_url }}" class="img-thumbnail" alt="Certificate" id="cert-{{ cert.id }}">
                                            {% elif cert.is_pdf %}
                                                <div class="pdf-thumbnail">
                                                    <i class="bi bi-file-pdf" style="font-size: 3rem; color: #dc3545;"></i>
                                                    <div class="pdf-filename-small">{{ cert.image.name|basename }}</div>
                                                </div>
                                            {% else %}
                                                <div class="file-thumbnail">
                                                    <i class="bi bi-file-earmark" style="font-size: 3rem; color: #6c757d;"></i>
                                                    <div class="file-filename-small">{{ cert.image.name|basename }}</div>
                                                </div>
                                            {% endif %}
                                            <div class="mt-2 text-center">
                                                <button type="button" class="btn btn-sm btn-danger delete-certificate" data-cert-id="{{ cert.id }}" data-cert-name="{{ cert.image.name|basename }}">
                                                    <i class="bi bi-trash"></i> حذف الشهادة
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Fire Extinguisher Images -->
                            <div class="mb-3">
                                <label for="fire_extinguisher_images" class="form-label fw-bold">صور طفاية الحريق</label>
                                <input type="file" class="form-control" id="fire_extinguisher_images" name="fire_extinguisher_images" multiple accept="image/*">
                                <div class="form-text">يمكنك اختيار صور متعددة لطفاية الحريق.</div>
                            </div>
                            
                            {% if equipment and equipment.fire_extinguisher_images.all %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">صور طفاية الحريق الموجودة</label>
                                <div class="row">
                                    {% for img in equipment.fire_extinguisher_images.all %}
                                    <div class="col-md-3 mb-2">
                                        <div class="image-container position-relative">
                                            <img src="{{ img.image|secure_media_url }}" class="img-thumbnail" alt="Fire Extinguisher Image" id="fire-img-{{ img.id }}">
                                            <div class="mt-2 text-center">
                                                <button type="button" class="btn btn-sm btn-danger delete-fire-extinguisher-image" data-img-id="{{ img.id }}" data-img-name="{{ img.image.name|basename }}">
                                                    <i class="bi bi-trash"></i> حذف الصورة
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Hidden inputs to track items to delete -->
                            <input type="hidden" name="images_to_delete" id="images-to-delete" value="">
                            <input type="hidden" name="certificates_to_delete" id="certificates-to-delete" value="">
                            <input type="hidden" name="fire_extinguisher_images_to_delete" id="fire-extinguisher-images-to-delete" value="">
                        </div>
                    </div>
                </div>
                
                <!-- Form Submit Button - Placed right after Images section -->
                <div class="card mb-3 border-success" id="form-submit-buttons" style="margin-top: 2rem;">
                    <div class="card-body" style="padding: 1.5rem; background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%); border-radius: 0.5rem;">
                        <div class="d-flex align-items-center gap-3" style="margin-right: 0; margin-left: auto;">
                            <button type="submit" class="btn btn-primary btn-lg" style="min-width: 200px; font-size: 1.1rem; padding: 0.75rem 2rem;">
                                <i class="bi bi-save"></i> {% if action == 'Create' %}إضافة معدة{% else %}تحديث المعدة{% endif %}
                            </button>
                            <a href="{% url 'equipment_list' %}" class="btn btn-secondary btn-lg" style="min-width: 150px; padding: 0.75rem 2rem;">
                                <i class="bi bi-x-circle"></i> إلغاء
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Empty form templates for dynamic form addition -->
                <!-- Empty License Form Template -->
                <div id="empty-license-form" style="display: none;">
                    <div class="license-form card mb-3" data-form-index="__prefix__">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-file-text"></i> سجل رخصة جديد</h6>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLicenseForm(this)">
                                <i class="bi bi-x-circle"></i> إزالة
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">تاريخ بداية رخصة المعدة *</label>
                                        {{ license_formset.empty_form.start_date }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">تاريخ انتهاء رخصة المعدة *</label>
                                        {{ license_formset.empty_form.end_date }}
                                    </div>
                                </div>
                            </div>
                            {% for hidden_field in license_formset.empty_form.hidden_fields %}
                                {{ hidden_field }}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Empty Inspection Form Template -->
                <div id="empty-inspection-form" style="display: none;">
                    <div class="inspection-form card mb-3" data-form-index="__prefix__">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> سجل فحص جديد</h6>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeInspectionForm(this)">
                                <i class="bi bi-x-circle"></i> إزالة
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">تاريخ بداية الفحص السنوي *</label>
                                        {{ inspection_formset.empty_form.start_date }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">تاريخ انتهاء الفحص السنوي *</label>
                                        {{ inspection_formset.empty_form.end_date }}
                                    </div>
                                </div>
                            </div>
                            {% for hidden_field in inspection_formset.empty_form.hidden_fields %}
                                {{ hidden_field }}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Empty Fire Extinguisher Form Template -->
                <div id="empty-fire-extinguisher-form" style="display: none;">
                    <div class="fire-extinguisher-form card mb-3" data-form-index="__prefix__">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-fire"></i> سجل طفاية حريق جديد</h6>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFireExtinguisherForm(this)">
                                <i class="bi bi-x-circle"></i> إزالة
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">تاريخ الفحص الدوري لطفاية الحريق *</label>
                                        {{ fire_extinguisher_formset.empty_form.inspection_date }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">تاريخ انتهاء طفاية الحريق *</label>
                                        {{ fire_extinguisher_formset.empty_form.expiry_date }}
                                    </div>
                                </div>
                            </div>
                            {{ fire_extinguisher_formset.empty_form.DELETE }}
                            {% for hidden_field in fire_extinguisher_formset.empty_form.hidden_fields %}
                                {{ hidden_field }}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Empty Maintenance Form Template -->
                <div id="empty-form" style="display: none;">
                    <div class="maintenance-form card mb-3" data-form-index="__prefix__">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-wrench"></i> سجل صيانة جديد</h6>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMaintenanceForm(this)">
                                <i class="bi bi-x-circle"></i> إزالة
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">تاريخ الصيانة *</label>
                                        {{ maintenance_formset.empty_form.maintenance_date }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">تاريخ الإصلاح</label>
                                        {{ maintenance_formset.empty_form.restoration_date }}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">التكلفة (ريال سعودي)</label>
                                        {{ maintenance_formset.empty_form.cost }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">الوصف</label>
                                        {{ maintenance_formset.empty_form.description }}
                                    </div>
                                </div>
                            </div>
                            {{ maintenance_formset.empty_form.DELETE }}
                            {% for hidden_field in maintenance_formset.empty_form.hidden_fields %}
                                {{ hidden_field }}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="{% static 'admin/css/vendor/select2/select2.min.css' %}" rel="stylesheet">
<style>
    /* Select2 RTL Support */
    .select2-container--default .select2-selection--single {
        height: 38px;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        direction: rtl;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 36px;
        padding-right: 12px;
        padding-left: 20px;
        direction: rtl;
        text-align: right;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
        right: 1px;
        left: auto;
    }
    
    .select2-container--default .select2-search--dropdown .select2-search__field {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 6px 12px;
        direction: rtl;
        text-align: right;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #667eea;
    }
    
    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: #764ba2;
    }
    
    .select2-dropdown {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        direction: rtl;
    }
    
    .select2-results__option {
        text-align: right;
        direction: rtl;
    }
    
    /* Ensure proper spacing for form fields */
    .form-group {
        margin-bottom: 1rem;
    }
    
    /* Fix any Bootstrap conflicts */
    .select2-container {
        z-index: 1050;
    }
    
    .select2-dropdown {
        z-index: 1051;
    }
    
    /* Collapsible card header styles */
    .card-header[data-bs-toggle="collapse"] {
        transition: background-color 0.2s ease;
    }
    
    .card-header[data-bs-toggle="collapse"]:hover {
        opacity: 0.9;
    }
    
    .collapse-icon {
        transition: transform 0.3s ease;
    }
    
    /* Ensure collapse cards have proper spacing */
    .card.mb-3 {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card-header {
        font-weight: 600;
    }
    
    /* Certificate deletion styles */
    .certificate-container {
        border: 2px solid transparent;
        border-radius: 8px;
        padding: 8px;
        transition: all 0.3s ease;
    }
    
    .certificate-container.marked-for-deletion {
        border-color: #dc3545;
        background-color: #f8d7da;
        opacity: 0.6;
    }
    
    .certificate-container.marked-for-deletion img {
        filter: grayscale(100%);
    }
    
    .delete-certificate {
        transition: all 0.3s ease;
    }
    
    .certificate-container.marked-for-deletion .delete-certificate {
        background-color: #6c757d;
        border-color: #6c757d;
    }
    
    /* Equipment image deletion styling */
    .image-container.marked-for-deletion {
        opacity: 0.6;
        background-color: #f8d7da;
        border-color: #dc3545;
        border-radius: 0.375rem;
        padding: 0.5rem;
    }
    
    .image-container.marked-for-deletion img {
        border-color: #dc3545;
        filter: grayscale(100%);
    }
    
    .image-container img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .pdf-thumbnail, .file-thumbnail {
        width: 100%;
        height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        text-align: center;
    }
    
    .pdf-filename-small, .file-filename-small {
        font-size: 0.7em;
        color: #6c757d;
        margin-top: 5px;
        word-break: break-all;
        max-width: 100%;
        padding: 0 5px;
    }
    
    .delete-image {
        transition: all 0.3s ease;
    }
    
    .image-container.marked-for-deletion .delete-image {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    
    /* Enhanced Maintenance Form Styling */
    .maintenance-form {
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .maintenance-form:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: #667eea;
    }
    
    .maintenance-form .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #dee2e6;
    }
    
    .maintenance-form .form-label {
        color: #495057;
        font-weight: 600;
    }
    
    .maintenance-form input[type="date"],
    .maintenance-form input[type="number"],
    .maintenance-form textarea {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .maintenance-form input[type="date"]:focus,
    .maintenance-form input[type="number"]:focus,
    .maintenance-form textarea:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: 0;
    }
    
    /* Animation for form addition/removal */
    .maintenance-form {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Styling for forms marked for deletion */
    .maintenance-form.marked-for-deletion {
        opacity: 0.6;
        background-color: #f8d7da;
        border-color: #dc3545;
    }
    
    .maintenance-form.marked-for-deletion .card-header {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border-bottom-color: #dc3545;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'admin/js/vendor/jquery/jquery.min.js' %}"></script>
<script src="{% static 'admin/js/vendor/select2/select2.full.min.js' %}"></script>
<script src="{% static 'admin/js/vendor/select2/i18n/ar.js' %}"></script>
<script>
    $(document).ready(function() {
        // Wait for jQuery to be fully loaded
        if (typeof $ !== 'undefined' && $.fn.select2) {
            // Initialize Select2 for all select fields (including cascading dropdowns)
            $('select:not([multiple])').each(function() {
                const $this = $(this);
                
                // Skip if already initialized
                if ($this.hasClass('select2-hidden-accessible')) {
                    return;
                }
                
                $this.select2({
                    language: 'ar',
                    placeholder: $this.data('placeholder') || $this.attr('data-placeholder') || 'اختر...',
                    allowClear: true,
                    width: '100%',
                    dir: 'rtl',
                    dropdownAutoWidth: true,
                    matcher: function(params, data) {
                        // If there are no search terms, return all data
                        if ($.trim(params.term) === '') {
                            return data;
                        }
                        
                        var searchTerm = params.term.toLowerCase();
                        
                        // Enhanced search function for Arabic, English, and numbers
                        function matchesSearch(text, term) {
                            if (!text) return false;
                            
                            // Convert to lowercase for case-insensitive search
                            var lowerText = text.toLowerCase();
                            
                            // Direct match
                            if (lowerText.indexOf(term) !== -1) {
                                return true;
                            }
                            
                            // Arabic number to English number conversion for search
                            var arabicToEnglish = {
                                '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
                                '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9'
                            };
                            
                            // Convert Arabic numbers to English in search term
                            var convertedTerm = term;
                            for (var arabic in arabicToEnglish) {
                                convertedTerm = convertedTerm.replace(new RegExp(arabic, 'g'), arabicToEnglish[arabic]);
                            }
                            
                            // Convert Arabic numbers to English in text
                            var convertedText = lowerText;
                            for (var arabic in arabicToEnglish) {
                                convertedText = convertedText.replace(new RegExp(arabic, 'g'), arabicToEnglish[arabic]);
                            }
                            
                            // Check if converted text matches converted term
                            if (convertedText.indexOf(convertedTerm) !== -1) {
                                return true;
                            }
                            
                            // English number to Arabic number conversion for search
                            var englishToArabic = {
                                '0': '٠', '1': '١', '2': '٢', '3': '٣', '4': '٤',
                                '5': '٥', '6': '٦', '7': '٧', '8': '٨', '9': '٩'
                            };
                            
                            // Convert English numbers to Arabic in search term
                            var arabicTerm = term;
                            for (var english in englishToArabic) {
                                arabicTerm = arabicTerm.replace(new RegExp(english, 'g'), englishToArabic[english]);
                            }
                            
                            // Convert English numbers to Arabic in text
                            var arabicText = lowerText;
                            for (var english in englishToArabic) {
                                arabicText = arabicText.replace(new RegExp(english, 'g'), englishToArabic[english]);
                            }
                            
                            // Check if Arabic text matches Arabic term
                            if (arabicText.indexOf(arabicTerm) !== -1) {
                                return true;
                            }
                            
                            return false;
                        }
                        
                        // Handle different data structures
                        if (data.children && data.children.length > 0) {
                            // Data has children (grouped options)
                            var filteredData = [];
                            data.children.forEach(function(child) {
                                if (matchesSearch(child.text, searchTerm)) {
                                    filteredData.push(child);
                                }
                            });
                            
                            if (filteredData.length > 0) {
                                return {
                                    results: filteredData
                                };
                            }
                        } else if (data.text) {
                            // Single option
                            if (matchesSearch(data.text, searchTerm)) {
                                return data;
                            }
                        }
                        
                        // Return null if no matches
                        return null;
                    }
                });
            });
            
            // Ensure cascading dropdowns (sector, department, division) are initialized with Select2
            $('#id_sector, #id_department, #id_division').each(function() {
                if (!$(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2({
                        language: 'ar',
                        placeholder: $(this).data('placeholder') || $(this).attr('data-placeholder') || 'اختر...',
                        allowClear: true,
                        width: '100%',
                        dir: 'rtl',
                        dropdownAutoWidth: true
                    });
                }
            });
        } else {
            console.error('Select2 or jQuery not loaded properly');
        }
        
        const statusField = document.getElementById('id_status');
        const maintenanceRecordsCard = document.getElementById('maintenance-records-card');
        
        // Setup status field change handler for maintenance records
        function setupStatusFieldHandler() {
            if (!statusField || !maintenanceRecordsCard) return;
            
            function toggleMaintenanceRecords() {
                const selectedStatus = statusField.value;
                if (selectedStatus === 'under_maintenance') {
                    maintenanceRecordsCard.style.display = 'block';
                    // Expand the maintenance section automatically
                    const collapseElement = document.getElementById('maintenanceRecordsCollapse');
                    if (collapseElement && !collapseElement.classList.contains('show')) {
                        const bsCollapse = new bootstrap.Collapse(collapseElement, {toggle: true});
                    }
                    // Only add a form if there are no existing forms
                    const existingForms = document.querySelectorAll('#maintenance-forms-container .maintenance-form');
                    if (existingForms.length === 0) {
                        addMaintenanceForm();
                    }
                } else {
                    maintenanceRecordsCard.style.display = 'none';
                }
            }
            
            // Handle both regular change and Select2 change events
            if ($(statusField).hasClass('select2-hidden-accessible')) {
                // Select2 is initialized, use Select2 event
                $(statusField).on('select2:select select2:clear', function() {
                    toggleMaintenanceRecords();
                });
            } else {
                // Regular select, use standard change event
                statusField.addEventListener('change', toggleMaintenanceRecords);
            }
            
            // Initial check
            toggleMaintenanceRecords();
        }
        
        // Setup handler after Select2 initialization
        if (typeof $ !== 'undefined' && $.fn.select2) {
            // Wait a bit for Select2 to initialize on status field
            setTimeout(function() {
                setupStatusFieldHandler();
            }, 500);
        } else {
            // If Select2 not available, setup immediately
            setupStatusFieldHandler();
        }
        
        // Initialize collapse icons based on initial state
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(element) {
            const icon = element.querySelector('.collapse-icon');
            const target = document.querySelector(element.getAttribute('data-bs-target'));
            if (icon && target) {
                // Set initial icon state
                if (target.classList.contains('show')) {
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-up');
                } else {
                    icon.classList.remove('bi-chevron-up');
                    icon.classList.add('bi-chevron-down');
                }
            }
        });
        
        // Collapse icon rotation on collapse/expand
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(element) {
            element.addEventListener('click', function() {
                const icon = this.querySelector('.collapse-icon');
                const target = document.querySelector(this.getAttribute('data-bs-target'));
                if (icon && target) {
                    setTimeout(function() {
                        if (target.classList.contains('show')) {
                            icon.classList.remove('bi-chevron-down');
                            icon.classList.add('bi-chevron-up');
                        } else {
                            icon.classList.remove('bi-chevron-up');
                            icon.classList.add('bi-chevron-down');
                        }
                    }, 10);
                }
            });
        });
        
        // Add a new license form
        window.addLicenseForm = function() {
            const totalForms = document.getElementById('id_license_records-TOTAL_FORMS');
            const formNum = parseInt(totalForms.value);
            const formRegex = RegExp(`license_records-(\\d+)-`,'g');
            
            let emptyForm = document.getElementById('empty-license-form');
            if (!emptyForm) return;
            
            let newForm = emptyForm.innerHTML.replace(formRegex, `license_records-${formNum}-`);
            const formContainer = document.createElement('div');
            formContainer.className = 'license-form card mb-3';
            formContainer.setAttribute('data-form-index', formNum);
            formContainer.innerHTML = newForm;
            
            const container = document.getElementById('license-forms-container');
            container.appendChild(formContainer);
            totalForms.value = formNum + 1;
        };
        
        // Add a new fire extinguisher form
        window.addFireExtinguisherForm = function() {
            const totalForms = document.getElementById('id_fire_extinguisher_records-TOTAL_FORMS');
            const formNum = parseInt(totalForms.value);
            const formRegex = RegExp(`fire_extinguisher_records-(\\d+)-`,'g');
            
            let emptyForm = document.getElementById('empty-fire-extinguisher-form');
            if (!emptyForm) return;
            
            let newForm = emptyForm.innerHTML.replace(formRegex, `fire_extinguisher_records-${formNum}-`);
            const formContainer = document.createElement('div');
            formContainer.className = 'fire-extinguisher-form card mb-3';
            formContainer.setAttribute('data-form-index', formNum);
            formContainer.innerHTML = newForm;
            
            const container = document.getElementById('fire-extinguisher-forms-container');
            container.appendChild(formContainer);
            totalForms.value = formNum + 1;
        };
        
        // Add a new inspection form
        window.addInspectionForm = function() {
            const totalForms = document.getElementById('id_inspection_records-TOTAL_FORMS');
            const formNum = parseInt(totalForms.value);
            const formRegex = RegExp(`inspection_records-(\\d+)-`,'g');
            
            let emptyForm = document.getElementById('empty-inspection-form');
            if (!emptyForm) return;
            
            let newForm = emptyForm.innerHTML.replace(formRegex, `inspection_records-${formNum}-`);
            const formContainer = document.createElement('div');
            formContainer.className = 'inspection-form card mb-3';
            formContainer.setAttribute('data-form-index', formNum);
            formContainer.innerHTML = newForm;
            
            const container = document.getElementById('inspection-forms-container');
            container.appendChild(formContainer);
            totalForms.value = formNum + 1;
        };
        
        // Add a new maintenance form
        window.addMaintenanceForm = function() {
            if (!maintenanceRecordsCard) return;
            
            const totalForms = document.getElementById('id_maintenance_set-TOTAL_FORMS');
            const formNum = parseInt(totalForms.value);
            const formRegex = RegExp(`maintenance_set-(\\d+)-`,'g');
            
            let emptyForm = document.getElementById('empty-form');
            if (!emptyForm) return;
            
            let newForm = emptyForm.innerHTML.replace(formRegex, `maintenance_set-${formNum}-`);
            const formContainer = document.createElement('div');
            formContainer.className = 'maintenance-form card mb-3';
            formContainer.setAttribute('data-form-index', formNum);
            formContainer.innerHTML = newForm;
            
            const container = document.getElementById('maintenance-forms-container');
            container.appendChild(formContainer);
            totalForms.value = formNum + 1;
        };
        
        // Remove a license form
        window.removeLicenseForm = function(button) {
            const formContainer = button.closest('.license-form');
            const deleteCheckbox = formContainer.querySelector('input[name$="-DELETE"]');
            
            if (deleteCheckbox) {
                // This is an existing record, mark it for deletion
                deleteCheckbox.checked = true;
                formContainer.style.opacity = '0.5';
                formContainer.style.backgroundColor = '#f8d7da';
                button.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> إلغاء الحذف';
                button.classList.remove('btn-outline-danger');
                button.classList.add('btn-warning');
                button.onclick = function() { undoRemoveLicenseForm(this); };
            } else {
                // This is a new form, remove it completely
                formContainer.remove();
                updateLicenseFormNumbers();
                updateLicenseTotalForms();
            }
        };
        
        // Remove an inspection form
        window.removeInspectionForm = function(button) {
            const formContainer = button.closest('.inspection-form');
            const deleteCheckbox = formContainer.querySelector('input[name$="-DELETE"]');
            
            if (deleteCheckbox) {
                // This is an existing record, mark it for deletion
                deleteCheckbox.checked = true;
                formContainer.style.opacity = '0.5';
                formContainer.style.backgroundColor = '#f8d7da';
                button.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> إلغاء الحذف';
                button.classList.remove('btn-outline-danger');
                button.classList.add('btn-warning');
                button.onclick = function() { undoRemoveInspectionForm(this); };
            } else {
                // This is a new form, remove it completely
                formContainer.remove();
                updateInspectionFormNumbers();
                updateInspectionTotalForms();
            }
        };
        
        // Remove a fire extinguisher form
        window.removeFireExtinguisherForm = function(button) {
            const formContainer = button.closest('.fire-extinguisher-form');
            const deleteCheckbox = formContainer.querySelector('input[name$="-DELETE"]');
            
            if (deleteCheckbox) {
                // This is an existing record, mark it for deletion
                deleteCheckbox.checked = true;
                formContainer.style.opacity = '0.5';
                formContainer.style.backgroundColor = '#f8d7da';
                button.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> إلغاء الحذف';
                button.classList.remove('btn-outline-danger');
                button.classList.add('btn-warning');
                button.onclick = function() { undoRemoveFireExtinguisherForm(this); };
            } else {
                // This is a new form, remove it completely
                formContainer.remove();
                updateFireExtinguisherFormNumbers();
                updateFireExtinguisherTotalForms();
            }
        };
        
        // Remove a maintenance form
        window.removeMaintenanceForm = function(button) {
            const formContainer = button.closest('.maintenance-form');
            const deleteCheckbox = formContainer.querySelector('input[name$="-DELETE"]');
            
            if (deleteCheckbox) {
                // This is an existing record, mark it for deletion
                deleteCheckbox.checked = true;
                formContainer.style.opacity = '0.5';
                formContainer.style.backgroundColor = '#f8d7da';
                button.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> إلغاء الحذف';
                button.classList.remove('btn-outline-danger');
                button.classList.add('btn-warning');
                button.onclick = function() { undoRemoveMaintenanceForm(this); };
            } else {
                // This is a new form, remove it completely
                formContainer.remove();
                updateFormNumbers();
                updateTotalForms();
            }
        };
        
        // Undo removal of a license form
        window.undoRemoveLicenseForm = function(button) {
            const formContainer = button.closest('.license-form');
            const deleteCheckbox = formContainer.querySelector('input[name$="-DELETE"]');
            
            deleteCheckbox.checked = false;
            formContainer.style.opacity = '';
            formContainer.style.backgroundColor = '';
            button.innerHTML = '<i class="bi bi-trash"></i> حذف السجل';
            button.classList.remove('btn-warning');
            button.classList.add('btn-danger');
            button.onclick = function() { removeLicenseForm(this); };
        };
        
        // Undo removal of an inspection form
        window.undoRemoveInspectionForm = function(button) {
            const formContainer = button.closest('.inspection-form');
            const deleteCheckbox = formContainer.querySelector('input[name$="-DELETE"]');
            
            deleteCheckbox.checked = false;
            formContainer.style.opacity = '';
            formContainer.style.backgroundColor = '';
            button.innerHTML = '<i class="bi bi-trash"></i> حذف السجل';
            button.classList.remove('btn-warning');
            button.classList.add('btn-danger');
            button.onclick = function() { removeInspectionForm(this); };
        };
        
        // Undo removal of a fire extinguisher form
        window.undoRemoveFireExtinguisherForm = function(button) {
            const formContainer = button.closest('.fire-extinguisher-form');
            const deleteCheckbox = formContainer.querySelector('input[name$="-DELETE"]');
            
            deleteCheckbox.checked = false;
            formContainer.style.opacity = '';
            formContainer.style.backgroundColor = '';
            button.innerHTML = '<i class="bi bi-trash"></i> حذف السجل';
            button.classList.remove('btn-warning');
            button.classList.add('btn-danger');
            button.onclick = function() { removeFireExtinguisherForm(this); };
        };
        
        // Undo removal of a maintenance form
        window.undoRemoveMaintenanceForm = function(button) {
            const formContainer = button.closest('.maintenance-form');
            const deleteCheckbox = formContainer.querySelector('input[name$="-DELETE"]');
            
            deleteCheckbox.checked = false;
            formContainer.style.opacity = '';
            formContainer.style.backgroundColor = '';
            button.innerHTML = '<i class="bi bi-trash"></i> حذف السجل';
            button.classList.remove('btn-warning');
            button.classList.add('btn-danger');
            button.onclick = function() { removeMaintenanceForm(this); };
        };
        
        // Update license form numbers in labels
        function updateLicenseFormNumbers() {
            const forms = document.querySelectorAll('#license-forms-container .license-form');
            forms.forEach((form, index) => {
                const label = form.querySelector('h6');
                if (label) {
                    label.innerHTML = `<i class="bi bi-file-text"></i> سجل رخصة ${index + 1}`;
                }
                form.setAttribute('data-form-index', index);
            });
        }
        
        // Update license total forms count
        function updateLicenseTotalForms() {
            const totalForms = document.getElementById('id_license_records-TOTAL_FORMS');
            if (totalForms) {
                const visibleForms = document.querySelectorAll('#license-forms-container .license-form');
                totalForms.value = visibleForms.length;
            }
        }
        
        // Update inspection form numbers in labels
        function updateInspectionFormNumbers() {
            const forms = document.querySelectorAll('#inspection-forms-container .inspection-form');
            forms.forEach((form, index) => {
                const label = form.querySelector('h6');
                if (label) {
                    label.innerHTML = `<i class="bi bi-clipboard-check"></i> سجل فحص ${index + 1}`;
                }
                form.setAttribute('data-form-index', index);
            });
        }
        
        // Update inspection total forms count
        function updateInspectionTotalForms() {
            const totalForms = document.getElementById('id_inspection_records-TOTAL_FORMS');
            if (totalForms) {
                const visibleForms = document.querySelectorAll('#inspection-forms-container .inspection-form');
                totalForms.value = visibleForms.length;
            }
        }
        
        // Update fire extinguisher form numbers in labels
        function updateFireExtinguisherFormNumbers() {
            const forms = document.querySelectorAll('#fire-extinguisher-forms-container .fire-extinguisher-form');
            forms.forEach((form, index) => {
                const label = form.querySelector('h6');
                if (label) {
                    label.innerHTML = `<i class="bi bi-fire"></i> سجل طفاية حريق ${index + 1}`;
                }
                form.setAttribute('data-form-index', index);
            });
        }
        
        // Update fire extinguisher total forms count
        function updateFireExtinguisherTotalForms() {
            const totalForms = document.getElementById('id_fire_extinguisher_records-TOTAL_FORMS');
            if (totalForms) {
                const visibleForms = document.querySelectorAll('#fire-extinguisher-forms-container .fire-extinguisher-form');
                totalForms.value = visibleForms.length;
            }
        }
        
        // Update form numbers in labels
        function updateFormNumbers() {
            const forms = document.querySelectorAll('#maintenance-forms-container .maintenance-form');
            forms.forEach((form, index) => {
                const label = form.querySelector('h6');
                if (label) {
                    label.innerHTML = `<i class="bi bi-wrench"></i> سجل صيانة ${index + 1}`;
                }
                form.setAttribute('data-form-index', index);
            });
        }
        
        // Update total forms count
        function updateTotalForms() {
            const totalForms = document.getElementById('id_maintenance_set-TOTAL_FORMS');
            if (totalForms) {
                const visibleForms = document.querySelectorAll('#maintenance-forms-container .maintenance-form');
                totalForms.value = visibleForms.length;
            }
        }
        
        // Certificate deletion functionality
        const certificatesToDelete = new Set();
        const certificatesToDeleteInput = document.getElementById('certificates-to-delete');
        
        // Handle certificate deletion
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-certificate') || e.target.closest('.delete-certificate')) {
                e.preventDefault();
                
                const button = e.target.classList.contains('delete-certificate') ? e.target : e.target.closest('.delete-certificate');
                const certId = button.getAttribute('data-cert-id');
                const certName = button.getAttribute('data-cert-name');
                const container = button.closest('.certificate-container');
                
                if (certificatesToDelete.has(certId)) {
                    // Remove from deletion list
                    certificatesToDelete.delete(certId);
                    container.classList.remove('marked-for-deletion');
                    button.innerHTML = '<i class="bi bi-trash"></i> حذف الشهادة';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-danger');
                } else {
                    // Add to deletion list
                    certificatesToDelete.add(certId);
                    container.classList.add('marked-for-deletion');
                    button.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> إلغاء الحذف';
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-secondary');
                }
                
                // Update hidden input
                certificatesToDeleteInput.value = Array.from(certificatesToDelete).join(',');
            }
        });
        
        // Equipment image deletion functionality
        const imagesToDelete = new Set();
        const imagesToDeleteInput = document.getElementById('images-to-delete');
        
        // Handle equipment image deletion
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-image') || e.target.closest('.delete-image')) {
                e.preventDefault();
                
                const button = e.target.classList.contains('delete-image') ? e.target : e.target.closest('.delete-image');
                const imgId = button.getAttribute('data-img-id');
                const imgName = button.getAttribute('data-img-name');
                const container = button.closest('.image-container');
                
                if (imagesToDelete.has(imgId)) {
                    // Remove from deletion list
                    imagesToDelete.delete(imgId);
                    container.classList.remove('marked-for-deletion');
                    button.innerHTML = '<i class="bi bi-trash"></i> حذف الصورة';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-danger');
                } else {
                    // Add to deletion list
                    imagesToDelete.add(imgId);
                    container.classList.add('marked-for-deletion');
                    button.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> إلغاء الحذف';
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-secondary');
                }
                
                // Update hidden input
                imagesToDeleteInput.value = Array.from(imagesToDelete).join(',');
            }
        });
        
        // Fire extinguisher image deletion functionality
        const fireExtinguisherImagesToDelete = new Set();
        const fireExtinguisherImagesToDeleteInput = document.getElementById('fire-extinguisher-images-to-delete');
        
        // Handle fire extinguisher image deletion
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-fire-extinguisher-image') || e.target.closest('.delete-fire-extinguisher-image')) {
                e.preventDefault();
                
                const button = e.target.classList.contains('delete-fire-extinguisher-image') ? e.target : e.target.closest('.delete-fire-extinguisher-image');
                const imgId = button.getAttribute('data-img-id');
                const imgName = button.getAttribute('data-img-name');
                const container = button.closest('.image-container');
                
                if (fireExtinguisherImagesToDelete.has(imgId)) {
                    // Remove from deletion list
                    fireExtinguisherImagesToDelete.delete(imgId);
                    container.classList.remove('marked-for-deletion');
                    button.innerHTML = '<i class="bi bi-trash"></i> حذف الصورة';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-danger');
                } else {
                    // Add to deletion list
                    fireExtinguisherImagesToDelete.add(imgId);
                    container.classList.add('marked-for-deletion');
                    button.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> إلغاء الحذف';
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-secondary');
                }
                
                // Update hidden input
                fireExtinguisherImagesToDeleteInput.value = Array.from(fireExtinguisherImagesToDelete).join(',');
            }
        });
        
        // Form submission confirmation
        document.getElementById('equipmentForm').addEventListener('submit', function(e) {
            if (certificatesToDelete.size > 0) {
                const certCount = certificatesToDelete.size;
                if (!confirm(`هل أنت متأكد من حذف ${certCount} شهادة معايرة؟`)) {
                    e.preventDefault();
                    return false;
                }
            }
            
            if (imagesToDelete.size > 0) {
                const imgCount = imagesToDelete.size;
                if (!confirm(`هل أنت متأكد من حذف ${imgCount} صورة؟`)) {
                    e.preventDefault();
                    return false;
                }
            }
            
            if (fireExtinguisherImagesToDelete.size > 0) {
                const imgCount = fireExtinguisherImagesToDelete.size;
                if (!confirm(`هل أنت متأكد من حذف ${imgCount} صورة طفاية حريق؟`)) {
                    e.preventDefault();
                    return false;
                }
            }
        });
    });
    
    // Nested Selector Functionality for Sector -> Department -> Division
    (function() {
        const sectorField = document.getElementById('id_sector');
        const departmentField = document.getElementById('id_department');
        const divisionField = document.getElementById('id_division');
        
        if (!sectorField || !departmentField || !divisionField) {
            return; // Fields not present, skip initialization
        }
        
        // Wait for Select2 to be initialized
        function initializeNestedSelectors() {
            // Ensure Select2 is initialized on all fields
            if ($(sectorField).hasClass('select2-hidden-accessible')) {
                setupNestedSelectors();
            } else {
                setTimeout(initializeNestedSelectors, 100);
            }
        }
        
        function setupNestedSelectors() {
            // Handle Sector change
            $(sectorField).on('select2:select select2:clear', function(e) {
                const sectorId = $(this).val();
                
                // Clear and disable department and division
                $(departmentField).val(null).trigger('change');
                $(divisionField).val(null).trigger('change');
                
                if (sectorId) {
                    // Fetch departments for this sector
                    fetchDepartments(sectorId);
                } else {
                    // Clear department options
                    $(departmentField).empty().trigger('change');
                    $(divisionField).empty().trigger('change');
                }
            });
            
            // Handle Department change
            $(departmentField).on('select2:select select2:clear', function(e) {
                const departmentId = $(this).val();
                
                // Clear division
                $(divisionField).val(null).trigger('change');
                
                if (departmentId) {
                    // Fetch divisions for this department
                    fetchDivisions(departmentId);
                } else {
                    // Clear division options
                    $(divisionField).empty().trigger('change');
                }
            });
            
            // Initialize with existing values if editing
            {% if equipment and equipment.sector %}
                const existingSectorId = {{ equipment.sector.id|default:"null" }};
                if (existingSectorId) {
                    fetchDepartments(existingSectorId, {{ equipment.department.id|default:"null" }}, {{ equipment.division.id|default:"null" }});
                }
            {% endif %}
        }
        
        function fetchDepartments(sectorId, selectedDeptId = null, selectedDivId = null) {
            $.ajax({
                url: '{% url "api_departments" %}',
                data: { sector_id: sectorId },
                dataType: 'json',
                success: function(response) {
                    // Clear existing options
                    $(departmentField).empty();
                    
                    // Add placeholder option
                    $(departmentField).append('<option value="">اختر الإدارة...</option>');
                    
                    // Add departments
                    response.departments.forEach(function(dept) {
                        const option = new Option(dept.name, dept.id, false, false);
                        option.dataset.isDummy = dept.is_dummy;
                        $(departmentField).append(option);
                    });
                    
                    // Select the previously selected department if provided
                    if (selectedDeptId) {
                        $(departmentField).val(selectedDeptId).trigger('change');
                        if (selectedDivId) {
                            fetchDivisions(selectedDeptId, selectedDivId);
                        }
                    } else {
                        $(departmentField).trigger('change');
                    }
                },
                error: function() {
                    console.error('Error fetching departments');
                }
            });
        }
        
        function fetchDivisions(departmentId, selectedDivId = null) {
            $.ajax({
                url: '{% url "api_divisions" %}',
                data: { department_id: departmentId },
                dataType: 'json',
                success: function(response) {
                    // Clear existing options
                    $(divisionField).empty();
                    
                    // Add placeholder option
                    $(divisionField).append('<option value="">اختر الدائرة...</option>');
                    
                    // Add divisions
                    response.divisions.forEach(function(div) {
                        const option = new Option(div.name, div.id, false, false);
                        option.dataset.isDummy = div.is_dummy;
                        $(divisionField).append(option);
                    });
                    
                    // Select the previously selected division if provided
                    if (selectedDivId) {
                        $(divisionField).val(selectedDivId).trigger('change');
                    } else {
                        $(divisionField).trigger('change');
                    }
                },
                error: function() {
                    console.error('Error fetching divisions');
                }
            });
        }
        
        // Initialize after page load
        $(document).ready(function() {
            setTimeout(initializeNestedSelectors, 500);
        });
    })();
</script>
{% endblock %}
