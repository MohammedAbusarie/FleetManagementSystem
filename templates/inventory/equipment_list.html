{% extends 'base.html' %}
{% load i18n %}
{% load inventory_extras %}

{% block title %}المعدات - نظام إدارة الأسطول{% endblock %}

{% block content %}
<style>
    /* Equipment table improvements - prevent cell wrapping */
    #equipmentTable {
        table-layout: auto;
        white-space: nowrap;
    }
    
    #equipmentTable th,
    #equipmentTable td {
        white-space: nowrap;
        overflow: visible;
        text-overflow: unset;
        padding: 8px 12px;
        vertical-align: middle;
    }
    
    /* Ensure table expands to accommodate content */
    #equipmentTable {
        min-width: auto;
        width: max-content;
    }
    
    /* Maintain responsive behavior while preventing wrapping */
    .table-responsive {
        overflow-x: auto;
        overflow-y: visible;
    }
    
    /* Improve readability with better spacing */
    #equipmentTable tbody tr {
        height: auto;
        min-height: 50px;
    }
    
    /* Ensure action buttons column doesn't shrink */
    #equipmentTable th:last-child,
    #equipmentTable td:last-child {
        min-width: 160px;
        width: auto;
    }
    
    /* Style for image column */
    #equipmentTable td img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 5px;
    }
    
    /* Specific column width optimizations */
    #equipmentTable th:nth-child(1), /* Door No */
    #equipmentTable td:nth-child(1) {
        min-width: 100px;
    }
    
    #equipmentTable th:nth-child(2), /* Plate No */
    #equipmentTable td:nth-child(2),
    #equipmentTable th:nth-child(3), /* Manufacture Year */
    #equipmentTable td:nth-child(3) {
        min-width: 120px;
    }
    
    #equipmentTable th:nth-child(4), /* Manufacturer */
    #equipmentTable td:nth-child(4),
    #equipmentTable th:nth-child(5), /* Model */
    #equipmentTable td:nth-child(5),
    #equipmentTable th:nth-child(6), /* Location */
    #equipmentTable td:nth-child(6),
    #equipmentTable th:nth-child(7), /* Sector */
    #equipmentTable td:nth-child(7),
    #equipmentTable th:nth-child(8) { /* Status */
        min-width: 130px;
    }
    
    #equipmentTable td:nth-child(8) {
        min-width: 130px;
        text-align: center;
    }
    
    /* Date columns */
    #equipmentTable th:nth-child(9), /* Equipment License Start Date */
    #equipmentTable td:nth-child(9),
    #equipmentTable th:nth-child(10), /* Equipment License End Date */
    #equipmentTable td:nth-child(10),
    #equipmentTable th:nth-child(11), /* Annual Inspection Start Date */
    #equipmentTable td:nth-child(11),
    #equipmentTable th:nth-child(12), /* Annual Inspection End Date */
    #equipmentTable td:nth-child(12),
    #equipmentTable th:nth-child(13), /* Last Maintenance Date */
    #equipmentTable td:nth-child(13),
    #equipmentTable th:nth-child(14), /* Last Maintenance Cost */
    #equipmentTable td:nth-child(14) {
        min-width: 140px;
    }
    
    /* Image column */
    #equipmentTable th:nth-child(15),
    #equipmentTable td:nth-child(15) {
        min-width: 80px;
        text-align: center;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-tools"></i> المعدات</h1>
        <a href="{% url 'equipment_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> إضافة معدة جديدة
        </a>
    </div>
    
    <!-- Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="search_query" class="form-control" placeholder="ابحث هنا..." value="{{ search_query }}">
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-3">
                        {% for field, label in search_fields %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="search_field" id="search_{{ field }}" value="{{ field }}" {% if search_field == field %}checked{% endif %}>
                            <label class="form-check-label" for="search_{{ field }}">
                                {% if label == 'Door No' %}رقم الباب
                                {% elif label == 'Plate No' %}رقم اللوحة
                                {% elif label == 'Manufacturer' %}الشركة المصنعة
                                {% else %}{{ label }}{% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> بحث
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Equipment Table -->
    <div class="card">
        <div class="card-body">
            {% if page_obj %}
                <div class="table-responsive" style="overflow-x: auto;">
                    <table class="table table-hover table-striped" id="equipmentTable">
                        <thead>
                            <tr>
                                <th data-sort="door_no">رقم الباب</th>
                                <th data-sort="plate_no">رقم اللوحة</th>
                                <th data-sort="manufacture_year">سنة التصنيع</th>
                                <th data-sort="manufacturer__name">الشركة المصنعة</th>
                                <th data-sort="model__name">الموديل</th>
                                <th data-sort="location__name">الموقع</th>
                                <th data-sort="sector__name">القطاع</th>
                                <th data-sort="status">الحالة</th>
                                <th data-sort="license_records__start_date">تاريخ بداية رخصة المعدة</th>
                                <th data-sort="license_records__end_date">تاريخ انتهاء رخصة المعدة</th>
                                <th data-sort="inspection_records__start_date">تاريخ بداية الفحص السنوي</th>
                                <th data-sort="inspection_records__end_date">تاريخ انتهاء الفحص السنوي</th>
                                <th data-sort="last_maintenance_date">تاريخ آخر صيانة</th>
                                <th data-sort="last_maintenance_cost">تكلفة آخر صيانة</th>
                                <th>صورة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for equipment in page_obj %}
                            <tr data-equipment-id="{{ equipment.pk }}">
                                <td>{{ equipment.door_no }}</td>
                                <td>{{ equipment.plate_no }}</td>
                                <td>{{ equipment.manufacture_year|default:"-" }}</td>
                                <td>{{ equipment.manufacturer.name }}</td>
                                <td>{{ equipment.model.name }}</td>
                                <td>{{ equipment.location.name }}</td>
                                <td>{{ equipment.sector.name }}</td>
                                <td>
                                    {% if equipment.status == 'operational' %}
                                        <span class="badge bg-success">عاملة</span>
                                    {% elif equipment.status == 'new' %}
                                        <span class="badge bg-info">جديدة</span>
                                    {% elif equipment.status == 'defective' %}
                                        <span class="badge bg-danger">معطلة</span>
                                    {% else %}
                                        <span class="badge bg-warning">تحت الصيانة</span>
                                    {% endif %}
                                </td>
                                <td>{% if equipment.current_license_record %}{{ equipment.current_license_record.start_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                                <td>{% if equipment.current_license_record %}{{ equipment.current_license_record.end_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                                <td>{% if equipment.current_inspection_record %}{{ equipment.current_inspection_record.start_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                                <td>{% if equipment.current_inspection_record %}{{ equipment.current_inspection_record.end_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                                <td dir="ltr">{% if equipment.last_maintenance_date %}{{ equipment.last_maintenance_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                                <td dir="ltr">{% if equipment.last_maintenance_cost %}{{ equipment.last_maintenance_cost|floatformat:2 }}{% else %}-{% endif %}</td>
                                <td>
                                    {% if equipment.equipment_image %}
                                        <img src="{{ equipment.equipment_image|secure_media_url }}" alt="{{ equipment.door_no }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                                    {% else %}
                                        <span class="text-muted">لا توجد صورة</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'equipment_detail' equipment.pk %}" class="btn btn-sm btn-info" title="عرض التفاصيل">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'equipment_update' equipment.pk %}" class="btn btn-sm btn-warning" title="تعديل">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{% url 'equipment_delete' equipment.pk %}" class="btn btn-sm btn-danger" title="حذف">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search_query={{ search_query }}&search_field={{ search_field }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}">السابق</a>
                        </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if search_query %}&search_query={{ search_query }}&search_field={{ search_field }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}">{{ num }}</a></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search_query={{ search_query }}&search_field={{ search_field }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}">التالي</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <p class="text-muted text-center">لم يتم العثور على معدات.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Equipment Detail Modal -->
<div class="modal fade" id="equipmentDetailModal" tabindex="-1" aria-labelledby="equipmentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="equipmentDetailModalLabel">تفاصيل المعدة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="equipment-details-content"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sorting functionality
        document.querySelectorAll('#equipmentTable th[data-sort]').forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                const sortBy = this.dataset.sort;
                const currentUrl = new URL(window.location.href);
                const currentSortBy = currentUrl.searchParams.get('sort_by');
                let sortOrder = '';

                if (currentSortBy === sortBy) {
                    sortOrder = currentUrl.searchParams.get('sort_order') === 'asc' ? 'desc' : 'asc';
                } else {
                    sortOrder = 'asc';
                }

                currentUrl.searchParams.set('sort_by', sortBy);
                currentUrl.searchParams.set('sort_order', sortOrder);
                window.location.href = currentUrl.toString();
            });
        });

        // Pop-up card functionality
        document.querySelectorAll('#equipmentTable tbody tr').forEach(row => {
            row.addEventListener('click', function(e) {
                // Don't trigger if clicking on action buttons
                if (e.target.closest('a.btn')) {
                    return;
                }
                
                const equipmentId = this.dataset.equipmentId;
                fetch(`/equipment/${equipmentId}/detail_json/`)
                    .then(response => response.json())
                    .then(data => {
                        let content = `
                            <div class="row">
                                <div class="col-md-4">
                                    ${data.equipment_image_url ? `
                                        <div class="text-center">
                                            <img src="${data.equipment_image_url}" class="img-fluid rounded mb-3" alt="${data.door_no}" style="max-height: 300px;">
                                            <br>
                                            <a href="${data.equipment_image_url}" download="${data.door_no}_image.jpg" class="btn btn-sm btn-info w-100">
                                                <i class="bi bi-download"></i> {% trans "Download Image" %}
                                            </a>
                                        </div>
                                    ` : `
                                        <div class="text-center">
                                            <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                                            <p class="text-muted">{% trans "No Image" %}</p>
                                        </div>
                                    `}
                                    ${data.calibration_certificates.length > 0 ? `
                                        <hr>
                                        <h6>{% trans "Calibration Certificates" %}:</h6>
                                        <div class="row">
                                            ${data.calibration_certificates.map((cert, index) => `
                                                <div class="col-6 mb-2">
                                                    <img src="${cert.image_url}" class="img-fluid rounded" alt="Certificate ${index + 1}" style="max-height: 100px;">
                                                    <br>
                                                    <a href="${cert.image_url}" download="${data.door_no}_certificate_${index + 1}.jpg" class="btn btn-sm btn-secondary w-100 mt-1">
                                                        <i class="bi bi-download"></i> {% trans "Download" %}
                                                    </a>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <hr>
                                        <h6>{% trans "Calibration Certificates" %}:</h6>
                                        <p class="text-muted">{% trans "No certificates" %}</p>
                                    `}
                                </div>
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>{% trans "Door No" %}:</strong> ${data.door_no}</p>
                                            <p><strong>{% trans "Plate No" %}:</strong> ${data.plate_no}</p>
                                            <p><strong>{% trans "Manufacture Year" %}:</strong> ${data.manufacture_year || '-'}</p>
                                            <p><strong>{% trans "Manufacturer" %}:</strong> ${data.manufacturer}</p>
                                            <p><strong>{% trans "Model" %}:</strong> ${data.model}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>{% trans "Location" %}:</strong> ${data.location}</p>
                                            <p><strong>{% trans "Sector" %}:</strong> ${data.sector}</p>
                                            <p><strong>{% trans "Status" %}:</strong> ${data.status_display}</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>{% trans "Equipment License Start Date" %}:</strong> ${data.equipment_license_start_date || '-'}</p>
                                            <p><strong>{% trans "Equipment License End Date" %}:</strong> ${data.equipment_license_end_date || '-'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>{% trans "Annual Inspection Start Date" %}:</strong> ${data.annual_inspection_start_date || '-'}</p>
                                            <p><strong>{% trans "Annual Inspection End Date" %}:</strong> ${data.annual_inspection_end_date || '-'}</p>
                                        </div>
                                    </div>
                                    ${data.maintenance_records.length > 0 ? `
                                        <hr>
                                        <h6>{% trans "Maintenance Records" %}:</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>تاريخ الصيانة</th>
                                                        <th>تاريخ الإصلاح</th>
                                                        <th>التكلفة</th>
                                                        <th>الوصف</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${data.maintenance_records.map(maint => `
                                                        <tr>
                                                            <td>${maint.maintenance_date || '-'}</td>
                                                            <td>${maint.restoration_date || '-'}</td>
                                                            <td>${maint.cost || '-'}</td>
                                                            <td>${maint.description || '-'}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : `
                                        <hr>
                                        <h6>{% trans "Maintenance Records" %}:</h6>
                                        <p class="text-muted">{% trans "No maintenance records" %}</p>
                                    `}
                                </div>
                            </div>
                        `;
                        document.getElementById('equipment-details-content').innerHTML = content;
                        var equipmentDetailModal = new bootstrap.Modal(document.getElementById('equipmentDetailModal'));
                        equipmentDetailModal.show();
                    })
                    .catch(error => console.error('Error fetching equipment details:', error));
            });
        });
    });
</script>
{% endblock %}
