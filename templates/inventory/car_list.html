{% extends 'base.html' %}
{% load i18n %}
{% load inventory_extras %}

{% block title %}السيارات - نظام إدارة الأسطول{% endblock %}

{% block content %}
<style>
    /* Car table improvements - prevent cell wrapping */
    #carTable {
        table-layout: auto;
        white-space: nowrap;
    }
    
    #carTable th,
    #carTable td {
        white-space: nowrap;
        overflow: visible;
        text-overflow: unset;
        padding: 8px 12px;
        vertical-align: middle;
    }
    
    /* Ensure table expands to accommodate content */
    #carTable {
        min-width: auto;
        width: max-content;
    }
    
    /* Maintain responsive behavior while preventing wrapping */
    .table-responsive {
        overflow-x: auto;
        overflow-y: visible;
    }
    
    /* Improve readability with better spacing */
    #carTable tbody tr {
        height: auto;
        min-height: 50px;
    }
    
    /* Ensure action buttons column doesn't shrink */
    #carTable th:last-child,
    #carTable td:last-child {
        min-width: 120px;
        width: auto;
    }
    
    /* Style for image column */
    #carTable td img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 5px;
    }
    
    /* Specific column width optimizations */
    #carTable th:nth-child(1), /* Fleet No */
    #carTable td:nth-child(1) {
        min-width: 100px;
    }
    
    #carTable th:nth-child(2), /* Plate No EN */
    #carTable td:nth-child(2),
    #carTable th:nth-child(3), /* Plate No AR */
    #carTable td:nth-child(3) {
        min-width: 120px;
    }
    
    #carTable th:nth-child(4), /* Department */
    #carTable td:nth-child(4),
    #carTable th:nth-child(5), /* Driver */
    #carTable td:nth-child(5) {
        min-width: 150px;
    }
    
    #carTable th:nth-child(6), /* Car Class */
    #carTable td:nth-child(6),
    #carTable th:nth-child(7), /* Manufacturer */
    #carTable td:nth-child(7),
    #carTable th:nth-child(8), /* Model */
    #carTable td:nth-child(8) {
        min-width: 130px;
    }
    
    #carTable th:nth-child(9), /* Functional Location */
    #carTable td:nth-child(9),
    #carTable th:nth-child(10), /* Room */
    #carTable td:nth-child(10),
    #carTable th:nth-child(11), /* Notification Recipient */
    #carTable td:nth-child(11),
    #carTable th:nth-child(12), /* Contract Type */
    #carTable td:nth-child(12),
    #carTable th:nth-child(13), /* Activity */
    #carTable td:nth-child(13) {
        min-width: 140px;
    }
    
    #carTable th:nth-child(14), /* Ownership Type */
    #carTable td:nth-child(14),
    #carTable th:nth-child(15), /* Status */
    #carTable td:nth-child(15) {
        min-width: 120px;
    }
    
    #carTable th:nth-child(16), /* Location Description */
    #carTable td:nth-child(16),
    #carTable th:nth-child(17), /* Address Details */
    #carTable td:nth-child(17) {
        min-width: 180px;
    }
    
    /* Date columns */
    #carTable th:nth-child(18), /* License Start */
    #carTable td:nth-child(18),
    #carTable th:nth-child(19), /* License End */
    #carTable td:nth-child(19),
    #carTable th:nth-child(20), /* Inspection Start */
    #carTable td:nth-child(20),
    #carTable th:nth-child(21), /* Inspection End */
    #carTable td:nth-child(21),
    #carTable th:nth-child(22), /* Last Maintenance Date */
    #carTable td:nth-child(22),
    #carTable th:nth-child(23), /* Last Maintenance Cost */
    #carTable td:nth-child(23) {
        min-width: 130px;
    }
    
    /* Image column */
    #carTable th:nth-child(24),
    #carTable td:nth-child(24) {
        min-width: 80px;
        text-align: center;
    }
    
    /* Visited Regions column */
    #carTable th:nth-child(25),
    #carTable td:nth-child(25) {
        min-width: 160px;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-car-front"></i> السيارات</h1>
        <a href="{% url 'car_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> إضافة سيارة جديدة
        </a>
    </div>
    
    <!-- Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="search_query" class="form-control" placeholder="ابحث هنا..." value="{{ search_query }}">
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-3">
                        {% for field, label in search_fields %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="search_field" id="search_{{ field }}" value="{{ field }}" {% if search_field == field %}checked{% endif %}>
                            <label class="form-check-label" for="search_{{ field }}">
                                {% if label == 'Fleet No' %}رقم الأسطول
                                {% elif label == 'Plate No (EN)' %}رقم اللوحة (إنجليزي)
                                {% elif label == 'Plate No (AR)' %}رقم اللوحة (عربي)
                                {% elif label == 'Manufacturer' %}الشركة المصنعة
                                {% else %}{{ label }}{% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> بحث
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Cars Table -->
    <div class="card">
        <div class="card-body">
            {% if page_obj %}
                <div class="table-responsive" style="overflow-x: auto;">
                    <table class="table table-hover table-striped" id="carTable">
                        <thead>
                            <tr>
                                <th data-sort="fleet_no">رقم الأسطول</th>
                                <th data-sort="plate_no_en">رقم اللوحة (الإنجليزية)</th>
                                <th data-sort="plate_no_ar">رقم اللوحة (العربية)</th>
                                <th data-sort="department_code__name">القسم</th>
                                <th data-sort="driver_name__name">السائق</th>
                                <th data-sort="car_class__name">فئة السيارة</th>
                                <th data-sort="manufacturer__name">الشركة المصنعة</th>
                                <th data-sort="model__name">الموديل</th>
                                <th data-sort="functional_location__name">الموقع الوظيفي</th>
                                <th data-sort="room__name">الغرفة</th>
                                <th data-sort="notification_recipient__name">مستلم الإشعار</th>
                                <th data-sort="contract_type__name">نوع العقد</th>
                                <th data-sort="activity__name">النشاط</th>
                                <th data-sort="ownership_type">نوع الملكية</th>
                                <th data-sort="status">الحالة</th>
                                <th data-sort="location_description">وصف الموقع</th>
                                <th data-sort="address_details_1">تفاصيل العنوان 1</th>
                                <th>تاريخ بداية رخصة السيارة</th>
                                <th>تاريخ انتهاء رخصة السيارة</th>
                                <th>تاريخ بداية الفحص السنوي</th>
                                <th>تاريخ انتهاء الفحص السنوي</th>
                                <th>تاريخ آخر صيانة</th>
                                <th>تكلفة آخر صيانة</th>
                                <th>صورة</th>
                                <th>المناطق المزارة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for car in page_obj %}
                            <tr>
                                <td>{{ car.fleet_no }}</td>
                                <td>{{ car.plate_no_en }}</td>
                                <td>{{ car.plate_no_ar }}</td>
                                <td>{{ car.department_code.name }}</td>
                                <td>{{ car.driver_name.name|default:"-" }}</td>
                                <td>{{ car.car_class.name }}</td>
                                <td>{{ car.manufacturer.name }}</td>
                                <td>{{ car.model.name }}</td>
                                <td>{{ car.functional_location.name }}</td>
                                <td>{{ car.room.name|default:"-" }}</td>
                                <td>{{ car.notification_recipient.name|default:"-" }}</td>
                                <td>{{ car.contract_type.name|default:"-" }}</td>
                                <td>{{ car.activity.name|default:"-" }}</td>
                                <td>{{ car.get_ownership_type_display }}</td>
                                <td>
                                    {% if car.status == 'operational' %}
                                        <span class="badge bg-success">عاملة</span>
                                    {% elif car.status == 'new' %}
                                        <span class="badge bg-info">جديدة</span>
                                    {% elif car.status == 'defective' %}
                                        <span class="badge bg-danger">معطلة</span>
                                    {% else %}
                                        <span class="badge bg-warning">تحت الصيانة</span>
                                    {% endif %}
                                </td>
                                <td>{{ car.location_description }}</td>
                                <td>{{ car.address_details_1|default:"-" }}</td>
                                <td>{{ car.current_license_record.start_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.current_license_record.end_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.current_inspection_record.start_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.current_inspection_record.end_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.last_maintenance_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.last_maintenance_cost|default:"-" }}</td>
                                <td>
                                    {% if car.car_image %}
                                        <img src="{{ car.car_image|secure_media_url }}" alt="{{ car.fleet_no }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                                    {% elif car.car_images.all %}
                                        {% with car.car_images.all|first as first_image %}
                                            <img src="{{ first_image.image|secure_media_url }}" alt="{{ car.fleet_no }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                                        {% endwith %}
                                    {% else %}
                                        <span class="text-muted">لا توجد صورة</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for region in car.visited_regions.all %}
                                        {{ region.name }}{% if not forloop.last %}, {% endif %}
                                    {% empty %}
                                        -
                                    {% endfor %}
                                </td>
                                <td>
                                    <a href="{% url 'car_detail' car.pk %}" class="btn btn-sm btn-info" title="عرض التفاصيل">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'car_update' car.pk %}" class="btn btn-sm btn-warning" title="تعديل">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{% url 'car_delete' car.pk %}" class="btn btn-sm btn-danger" title="حذف">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search_query={{ search_query }}&search_field={{ search_field }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}">السابق</a>
                        </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if search_query %}&search_query={{ search_query }}&search_field={{ search_field }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}">{{ num }}</a></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search_query={{ search_query }}&search_field={{ search_field }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}">التالي</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <p class="text-muted text-center">لم يتم العثور على سيارات.</p>
            {% endif %}
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sorting functionality
        document.querySelectorAll('#carTable th[data-sort]').forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                const sortBy = this.dataset.sort;
                const currentUrl = new URL(window.location.href);
                const currentSortBy = currentUrl.searchParams.get('sort_by');
                let sortOrder = '';

                if (currentSortBy === sortBy) {
                    sortOrder = currentUrl.searchParams.get('sort_order') === 'asc' ? 'desc' : 'asc';
                } else {
                    sortOrder = 'asc';
                }

                currentUrl.searchParams.set('sort_by', sortBy);
                currentUrl.searchParams.set('sort_order', sortOrder);
                window.location.href = currentUrl.toString();
            });
        });

    });
</script>
{% endblock %}
