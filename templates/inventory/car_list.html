{% extends 'base.html' %}
{% load i18n %}
{% load inventory_extras %}

{% block title %}السيارات - نظام إدارة الأسطول{% endblock %}

{% block content %}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-car-front"></i> السيارات</h1>
        <a href="{% url 'car_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> إضافة سيارة جديدة
        </a>
    </div>
    
    <!-- Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="search_query" class="form-control" placeholder="ابحث هنا..." value="{{ search_query }}">
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-3">
                        {% for field, label in search_fields %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="search_field" id="search_{{ field }}" value="{{ field }}" {% if search_field == field %}checked{% endif %}>
                            <label class="form-check-label" for="search_{{ field }}">
                                {% if label == 'Fleet No' %}رقم الأسطول
                                {% elif label == 'Plate No (EN)' %}رقم اللوحة (إنجليزي)
                                {% elif label == 'Plate No (AR)' %}رقم اللوحة (عربي)
                                {% elif label == 'Manufacturer' %}الشركة المصنعة
                                {% else %}{{ label }}{% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> بحث
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Cars Table -->
    <div class="card">
        <div class="card-body">
            {% if page_obj %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="carTable">
                        <thead>
                            <tr>
                                <th data-sort="fleet_no">رقم الأسطول</th>
                                <th data-sort="plate_no_en">رقم اللوحة (الإنجليزية)</th>
                                <th data-sort="plate_no_ar">رقم اللوحة (العربية)</th>
                                <th data-sort="department_code__name">القسم</th>
                                <th data-sort="driver_name__name">السائق</th>
                                <th data-sort="car_class__name">فئة السيارة</th>
                                <th data-sort="manufacturer__name">الشركة المصنعة</th>
                                <th data-sort="model__name">الموديل</th>
                                <th data-sort="functional_location__name">الموقع الوظيفي</th>
                                <th data-sort="room__name">الغرفة</th>
                                <th data-sort="notification_recipient__name">مستلم الإشعار</th>
                                <th data-sort="contract_type__name">نوع العقد</th>
                                <th data-sort="activity__name">النشاط</th>
                                <th data-sort="ownership_type">نوع الملكية</th>
                                <th data-sort="status">الحالة</th>
                                <th data-sort="location_description">وصف الموقع</th>
                                <th data-sort="address_details_1">تفاصيل العنوان 1</th>
                                <th>تاريخ بداية رخصة السيارة</th>
                                <th>تاريخ انتهاء رخصة السيارة</th>
                                <th>تاريخ بداية الفحص السنوي</th>
                                <th>تاريخ انتهاء الفحص السنوي</th>
                                <th>تاريخ آخر صيانة</th>
                                <th>تكلفة آخر صيانة</th>
                                <th>صورة</th>
                                <th>المناطق المزارة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for car in page_obj %}
                            <tr>
                                <td>{{ car.fleet_no }}</td>
                                <td>{{ car.plate_no_en }}</td>
                                <td>{{ car.plate_no_ar }}</td>
                                <td>{{ car.department_code.name }}</td>
                                <td>{{ car.driver_name.name|default:"-" }}</td>
                                <td>{{ car.car_class.name }}</td>
                                <td>{{ car.manufacturer.name }}</td>
                                <td>{{ car.model.name }}</td>
                                <td>{{ car.functional_location.name }}</td>
                                <td>{{ car.room.name|default:"-" }}</td>
                                <td>{{ car.notification_recipient.name|default:"-" }}</td>
                                <td>{{ car.contract_type.name|default:"-" }}</td>
                                <td>{{ car.activity.name|default:"-" }}</td>
                                <td>{{ car.get_ownership_type_display }}</td>
                                <td>
                                    {% if car.status == 'operational' %}
                                        <span class="badge bg-success">عاملة</span>
                                    {% elif car.status == 'new' %}
                                        <span class="badge bg-info">جديدة</span>
                                    {% elif car.status == 'defective' %}
                                        <span class="badge bg-danger">معطلة</span>
                                    {% else %}
                                        <span class="badge bg-warning">تحت الصيانة</span>
                                    {% endif %}
                                </td>
                                <td>{{ car.location_description }}</td>
                                <td>{{ car.address_details_1|default:"-" }}</td>
                                <td>{{ car.current_license_record.start_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.current_license_record.end_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.current_inspection_record.start_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.current_inspection_record.end_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.last_maintenance_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ car.last_maintenance_cost|default:"-" }}</td>
                                <td>
                                    {% if car.car_image %}
                                        <img src="{{ car.car_image|secure_media_url }}" alt="{{ car.fleet_no }}" class="table-img">
                                    {% elif car.car_images.all %}
                                        {% with car.car_images.all|first as first_image %}
                                            <img src="{{ first_image.image|secure_media_url }}" alt="{{ car.fleet_no }}" class="table-img">
                                        {% endwith %}
                                    {% else %}
                                        <span class="text-muted">لا توجد صورة</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for region in car.visited_regions.all %}
                                        {{ region.name }}{% if not forloop.last %}, {% endif %}
                                    {% empty %}
                                        -
                                    {% endfor %}
                                </td>
                                <td>
                                    <a href="{% url 'car_detail' car.pk %}" class="btn btn-sm btn-info" title="عرض التفاصيل">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'car_update' car.pk %}" class="btn btn-sm btn-warning" title="تعديل">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{% url 'car_delete' car.pk %}" class="btn btn-sm btn-danger" title="حذف">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search_query={{ search_query }}&search_field={{ search_field }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}">السابق</a>
                        </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if search_query %}&search_query={{ search_query }}&search_field={{ search_field }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}">{{ num }}</a></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search_query={{ search_query }}&search_field={{ search_field }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}">التالي</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <p class="text-muted text-center">لم يتم العثور على سيارات.</p>
            {% endif %}
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
// Car List JavaScript - Clean and Simple
document.addEventListener('DOMContentLoaded', function() {
    // Sorting functionality
    const sortHeaders = document.querySelectorAll('#carTable th[data-sort]');
    if (sortHeaders.length === 0) return; // Not on car list page
    
    sortHeaders.forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            const sortBy = this.dataset.sort;
            const currentUrl = new URL(window.location.href);
            const currentSortBy = currentUrl.searchParams.get('sort_by');
            let sortOrder = '';

            if (currentSortBy === sortBy) {
                sortOrder = currentUrl.searchParams.get('sort_order') === 'asc' ? 'desc' : 'asc';
            } else {
                sortOrder = 'asc';
            }

            currentUrl.searchParams.set('sort_by', sortBy);
            currentUrl.searchParams.set('sort_order', sortOrder);
            window.location.href = currentUrl.toString();
        });
    });
});
</script>
{% endblock %}
